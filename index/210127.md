

# 목차

- [목차](#목차)
- [1. 검색하는 흐름](#1-검색하는-흐름)
  - [1.1 select.jsp](#11-selectjsp)
  - [1.2. member.js](#12-memberjs)
  - [1.3. member-servlet.xml](#13-member-servletxml)
  - [1.4. MemberController.java](#14-membercontrollerjava)
  - [1.5.](#15)
  - [1.6.](#16)
  - [1.7. MemberDao,java](#17-memberdaojava)
  - [1.8. MemberController.java](#18-membercontrollerjava)
  - [1.9. select.jsp](#19-selectjsp)
- [2. view의 흐름](#2-view의-흐름)
  - [2.1. select.jsp](#21-selectjsp)
  - [2.2. MemberController.java](#22-membercontrollerjava)
  - [2.3. MemberDao.java](#23-memberdaojava)
  - [2.* 인코딩필터 추가(web.xml)](#2-인코딩필터-추가webxml)
- [3. insert 흐름](#3-insert-흐름)
# 1. 검색하는 흐름
## 1.1 select.jsp
```html
<form name='frm_member' id = 'frmMember' method = 'post' action = 'insertR.mem'>
			<input type = 'button' id='btnInsert' value = '입력' />
			<div>
				<input type = 'search' name = 'findStr' value='${param.findStr }'/>
				<input type = 'button' value = '검색' id = 'btnFind' />
				<input type = 'text' name = 'nowPage' value = '${(empty nowPage)? 1: nowPage}' />
				<input type = 'text' name = 'mid'/>
			</div>
		</form>
```

## 1.2. member.js
- action을 넘겨줌
```javascript
if(btnFind != null){
		btnFind.onclick = function(){
			var frm = document.frm_member;
			frm.action = "select.mem";
			frm.nowPage.value = 1;
			frm.submit();
		}
	}
```

## 1.3. member-servlet.xml
- dispatcher파일이 받음
- controller, viewresolver가 누군지 여기서 확인
  - controller에게 select.mem을 넘겨주겠구나
```xml
	
	<bean id = 'myba' class = 'bean.MemberFactory' />
	<bean id ='mDao' class ='member.MemberDao'>
		<constructor-arg ref='myba'/>
	</bean>
	<bean id ='mController' class = 'member.MemberController'>
		<constructor-arg ref="mDao"/> <!-- 셍성자를 통해 주입 -->
		
	</bean>

	<bean class='org.springframework.web.servlet.view.InternalResourceViewResolver'>
		<property name="prefix" value="/WEB-INF/member/"/>
		<property name="suffix" value = '.jsp'/> 
	</bean>
```

## 1.4. MemberController.java
- @Controller라는 annotation이 붙어있는 걸로 확인
- select.mem 이 있는 메소드로 감
- page라는 부분은 spring이 `di`로 주입
  - parameter가 들어오면 setter로 설정
- 그 다음은 dao의 select부분을 가봐야함
```java

@Controller
public class MemberController {
	
	Dao dao ; 
	public MemberController() {	}
	public MemberController(Dao dao) { 
		//생성자를 통해 dao를 넘겨받음, dao는 인터페이스일것이다
		//memberdao는 dao를 구현한 것 
		this.dao = dao;
	}
	@RequestMapping(value = "select.mem", method = {RequestMethod.GET, RequestMethod.POST})
	public ModelAndView select(Page page) { 
		ModelAndView mv = new ModelAndView();
		
		List<MemberVo> list = null;

		if(page != null) {
		System.out.println("controller.select()....");
		System.out.println("nowPage :" + page.getNowPage());
		}else {
			System.out.println("page is null");
		}
		
		
		//page만든 후(dao에서) dao호출
		Map<String, Object> map = dao.select(page); //select의 반환형은 list<MemberVo>
		page = (Page)map.get("page");
		list = (List<MemberVo>)map.get("list");
		
		mv.addObject("page", page);
		mv.addObject("list", list);
		mv.setViewName("select"); //WEB-INF/member/select.jsp가 viewResolver됨

		return mv;
		
	}
```

## 1.5.
- page정보를 주고 `int cnt = sqlsession.selectOne("member.tot_list_size", p);`를 호출
  - member라는 namespace의 tot_list_size라는 id값을 호출해서 그 결과를 하나만 반환하라
    - mybatis로 가자
  - member라는  namespace의 select라는 id값을 호출해서 그 결과를 list로 반환하라
```java
	@Override
	public Map<String, Object> select(Page p) {
		Map<String, Object> map = new HashMap<String, Object>();
		
		//page가 null이면 nowpage에 1 넣어준다
		if(p==null) {
			p = new Page();
			p.setNowPage(1);
		}else if(p.getNowPage()<1) {
			p.setNowPage(1);
		}
		
		System.out.println("Dao.select().............");
		System.out.println("nowPage : " + p.getNowPage());
		
		int cnt = sqlsession.selectOne("member.tot_list_size", p); //member안의 tot_list_size
		p.setTotListSize(cnt);
		p.pageCompute();
		
		System.out.println("startNo : " + p.getStartPage());
		System.out.println("endPage : " + p.getEndPage());

		List<MemberVo> list = sqlsession.selectList("member.select", p); // namespace member안의 id값 
		
		System.out.println("list.size : " + list.size());
		map.put("list", list);
		map.put("page", p);
		
		return map;
	}
```

## 1.6.
- 동적쿼리
  - findStrList라는 것을 하나씩 가져와서 반복해달라  
  
`tot_list_size`
- selectOne으로 반환
```xml
 <select id="tot_list_size" parameterType="page" resultType="int"> 
      select count(mid) cnt from membervo <!-- 반환된 cnt는 int타입 -->
      <where>
		<foreach collection="findStrList" item="v" open="(" close=")" separator="or">
	          mid like '%${v}%' or email   like '%${v}%' 
	      or  phone like '%${v}%' or address like '%${v}%'
		</foreach>			
      </where>
   </select>
```
`select`
- where절은 위의 tot_list_size와 정확히 같아야한다
- selectList로 반환
```xml
  <select id="select" parameterType="page" resultType="mVo" > <!-- mVo conflg.xml에서 별명 지었음-->
      select * from (
          select rownum no, m.* from (
         select * from membervo 
        <where>
			<foreach collection="findStrList" item="v" open="(" close=")" separator="or">
		          mid like '%${v}%' or email   like '%${v}%' 
		      or  phone like '%${v}%' or address like '%${v}%'
			</foreach>			
      </where>
         order by name asc) m  
      ) where no between #{startNo} and #{endNo} 
   </select>
```

## 1.7. MemberDao,java
- map으로 반환

## 1.8. MemberController.java
- select.jsp로 넘어감

## 1.9. select.jsp
- 받아서 list, paging 처리를 함
- jstl 사용하면 표기방법이 쉽다
```jsp
	<div id = 'listItems'>
		<c:forEach var = 'v' items="${list }">
			<div class = 'item' onclick = 'view(${v.mid})'>
				<img src = 'http://placehold.it/150x200' align = 'left' >
				<span>${v.mid }</span><br>
				<span>${v.name }</span><br>
				<span>${v.phone }</span><br>
				<span>${v.email }</span><br>
			</div>
		</c:forEach>
	</div>
	
	<div id = 'btnZone'>
		<c:if test="${page.startPage >1 }">
			<input type = 'button' value = '맨첨' id = 'btnFirst' onclick ='goPage(1)'/>
			<input type = 'button' value = '이전' id = 'btnprev' onclick = 'goPage(${page.startPage-1})'/>
		</c:if>

		<c:forEach var="i" begin = "${page.startPage }" end = "${page.endPage }">
			<input type = 'button' value = '${i }' onclick = 'goPage(${i})'/>
		</c:forEach>

		<c:if test="${page.endPage < page.totPage }">
			<input type = 'button' value = '다음' id = 'btnNext' onclick = 'goPage(${page.endPage+1})'/>
			<input type = 'button' value = '맨끝' id = 'btnLast' onclick = 'goPage(${page.totPage})'/>
		</c:if>		
	</div>
```

# 2. view의 흐름

## 2.1. select.jsp
```jsp
		<form name='frm_member' id = 'frmMember' method = 'post' action = 'insertR.mem'>
			<input type = 'button' id='btnInsert' value = '입력' />
			<div>
				<input type = 'search' name = 'findStr' value='${param.findStr }'/>
				<input type = 'button' value = '검색' id = 'btnFind' />
				<input type = 'text' name = 'nowPage' value = '${(empty nowPage)? 1: nowPage}' />
				<input type = 'text' name = 'mid'/>
			</div>
		</form>
```
## 2.2. MemberController.java
- 넘어온 것들
  - findStr, nowPage
    - 이 두개는 param.로 설정하는게 낫다
  - mid 
    - memberVo에 가면 setMid()가 있을 것
```java
	@RequestMapping(value= "view.mem", method = RequestMethod.POST)
	public ModelAndView view(MemberVo vo) {
		ModelAndView mv = new ModelAndView();
		
		System.out.println("controller.view().....");
		System.out.println(vo.getMid());
		
		vo = dao.view(vo.getMid());
		
		
		return mv;
	}
```
- requestmapping으로 value값과 method 지정해주고
- 반환값은 model과 view가 같이 반환되는 model and view를 반환값으로
## 2.3. MemberDao.java
- spring은 싱글톤이라서 객체를 하나만 만듬
  - sqlsession 매번 열어주기
```java
	public MemberVo view(String mid) {
		sqlsession = f.getFactory().openSession();

		MemberVo vo = sqlsession.selectOne("member.view", mid);
		
		System.out.println(vo.getName());
		sqlsession.close();
		return vo;
		
	}
```

## 2.* 인코딩필터 추가(web.xml)
```xml
	<filter>
		<filter-name>encoding-filter</filter-name>
		<filter-class>
			org.springframework.web.filter.CharacterEncodingFilter
		</filter-class>
		<init-param>
			<param-name>encoding</param-name>
			<param-value>utf-8</param-value>
		</init-param>
	</filter>
	<filter-mapping>
			<filter-name>encoding-filter</filter-name>
			<url-pattern>/*</url-pattern>
	</filter-mapping>
```


# 3. insert 흐름
- btnInsert-con-dao-my-dao-con-select.jsp

`HTTP 상태 405 – 허용되지 않는 메소드`  
`Request method 'POST' not supported`
- 405 에러는 controller의심해봐야함